<!DOCTYPE html>
<!-- page pour tester un script iep sans passer par un fichier -->
<html>
<head>
  <title>Test d'une figure iep</title>
	<meta http-equiv="X-UA-Compatible" content="IE=9">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script type="text/javascript" src="iepjsmax.js"></script>
  <script type="text/javascript" src="librairies/MathJax/MathJax.js?config=TeX-AMS-MML_SVG-full.js"></script>
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [["$","$"],["\\(","\\)"]]
      },
      jax: ["input/TeX","output/SVG"],
      TeX: {extensions: ["color.js"]},
      messageStyle:'none'
    });
  </script>
  <style type="text/css">
    label {display: block;}
    #xmlSrc {resize: both; width: 100%; overflow: auto;}
    #display {padding: 5px;}
    #svg {border: #333 solid thin; margin: 0 auto;}
  </style>


<!-- JQuery-->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

  <!-- Semantic UI-->
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.0/components/state.min.js"></script> 

  <!-- Algebrite-->
  <script src="include/algebrite.bundle-compressed.js" type="text/javascript" ></script>

  <!-- Clipboard-->
  <script src="include/clipboard.min.js" type="text/javascript"></script>

  <!-- KaTeX et auto-render-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
  <script  src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
  <script  src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" ></script>

  <!-- CodeMirror-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/codemirror.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/theme/monokai.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/codemirror.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/mode/javascript/javascript.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/mode/xml/xml.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/mode/htmlmixed/htmlmixed.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/mode/stex/stex.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/addon/hint/javascript-hint.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/addon/hint/show-hint.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/addon/edit/closebrackets.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/addon/hint/show-hint.min.css">
  
  <!-- MathALEA-->
  <script type="text/javascript" src="include/mathalea_outils.js"></script>
  <script type="text/javascript" src="include/mathalea2d.js"></script>
  <script type="text/javascript" src="include/mathalea2iep.js"></script>
  <link rel="stylesheet" type="text/css" href="style/style_mathalea.css">



</head>

<body>

<div class="ui hidden divider"></div>

  <div class="ui hidden divider"></div>

  <div class="stackable ui grid">
    <div class="two column row">
      <div class="column" >
        <h3>MathALEA 2D</h3>
        <div id="editeur"></div>
        <button class="btn ui labeled icon button" id="submit" style="margin:10px"><i class="redo icon"></i>Actualiser</button> <button class="btn ui labeled icon button"  style="margin:10px" onclick="window.location.href='https://coopmaths.fr/mathalea2d_tuto/'"><i class="info circle icon"></i>Aide</button>
      </div>
      <div class="column">
        <h3>Aperçu SVG</h3>
        <div id = "svg" style="cursor: move;"></div>  
      </div>
    </div>
    
  </div>

  <div id="errors"></div>
  <form id="iepForm">
    <label for="xmlSrc">Contenu du script iep (glisser un fichier xml ici ou copier / coller le code d'un script et
      cliquer sur aperçu)</label>
    <textarea id="xmlSrc" rows="10"></textarea>
    <br />
    <button id="previewBtn">Aperçu</button>
  </form>
  <div id="display"></div>

  <script type="text/javascript">

    function displayError(error) {
      console.error(error)
      var pre = document.createElement('pre')
      var txt = document.createTextNode(error.toString())
      pre.appendChild(txt);
      document.getElementById('errors').appendChild(pre)
      window.scrollTo(0)
    }

    function display(event) {
      try {
        event.preventDefault()
        event.stopPropagation()
        var display = document.getElementById("display")
        // on nettoie
        for (var i = 0; i < display.childNodes.length; ++i) {
          var item = display.childNodes[i]
          display.removeChild(item)
        }
        var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg')
        svg.id = 'svgIEP'
        var largeur = Math.max(display.offsetWidth - 20 || 0, 800)
        svg.style.width = largeur + 'px'
        svg.setAttribute('width', largeur)
        var hTot = window.innerHeight || 400
        var hForm = document.getElementById('iepForm').offsetHeight || 200
        var hauteur = Math.max(hTot - hForm - 40, 700)
        svg.style.height = hauteur + 'px'
        svg.setAttribute('height', hauteur)
        display.appendChild(svg)
        var iepApp = new iep.iepApp()
        var xmlElt = document.getElementById('xmlSrc')
        iepApp.addDoc("svgIEP", xmlElt.value, true)
      } catch (error) {
        displayError("Plantage à l'affichage, xml probablement malformé")
        console.error(error)
      }
    }

    function dropHandler(event) {
      event.stopPropagation();
      event.preventDefault();
      try {
        var files = event.dataTransfer.files; // FileList object.
        if (files && files[0]) {
          var file = files[0]
          console.log("On récupère le fichier ", file.name)
          if (file.name.substr(-4) === '.xml') {
            var reader = new FileReader();
            reader.onload = function (event) {
              document.getElementById("xmlSrc").value = event.target.result
              display(event)
            };
            reader.readAsText(file);
          } else {
            displayError("On ne gère que les fichiers xml");
          }
        }
      } catch (error) {
        displayError("Plantage à la récupération du fichier")
        displayError(error)
      }
    }

    function dragOverHandler(event) {
      event.stopPropagation();
      event.preventDefault();
      // faut préciser ça explicitement
      event.dataTransfer.dropEffect = 'copy';
    }

    // et on ajoute les listener
    var previewBtn = document.getElementById('previewBtn')
    previewBtn.addEventListener('click', display, false)
    var textarea = document.getElementById('xmlSrc')
    textarea.addEventListener('dragover', dragOverHandler, false);
    textarea.addEventListener('drop', dropHandler, false);
  </script>
</body>
</html>
